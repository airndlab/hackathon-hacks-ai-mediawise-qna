name: mw

services:
  qna:
    image: airndlab/mediawise-rag:latest
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: [ '0' ]
              capabilities: [ gpu ]
    ports:
      - 8080:8080
    volumes:
      - ./config:/config
      - ./dataset:/data/dataset
    environment:
      - VLLM_URL=http://vllm:8000/v1
      - CHROMA_HOSTNAME=chroma
      - CHROMA_PORT=8000
      - YANDEX_API_TOKEN=${YANDEX_API_TOKEN}
      - MAIN_DOCS_DIR=/data/dataset
      - PROMPTS_CONFIG_PATH=/config/prompts.yaml
      - RAG_CONFIG_PATH=/config/rag.yaml
      - API_CONFIG_PATH=/config/api.yaml
    networks:
      - rzd-net

  searxng:
    image: searxng/searxng:2024.11.8-2fbf15ecc
    restart: unless-stopped
    volumes:
      - ./config/searxng:/etc/searxng:rw
    ports:
      - 4000:8080
    networks:
      - mw-net

  perplexica-backend:
    image: airndlab/perplexica-backend:2024.11.10-07-41
    restart: unless-stopped
    depends_on:
      - searxng
    environment:
      - SEARXNG_API_URL=http://searxng:8080
    ports:
      - 3001:3001
    volumes:
      - ./data/perplexica-backend:/home/perplexica/data
      - ./config/web.config.toml:/home/perplexica/config.toml
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    networks:
      - mw-net

  perplexica-frontend:
    image: airndlab/perplexica-frontend:2024.11.09-21-44
    restart: unless-stopped
    depends_on:
      - perplexica-backend
    environment:
      - NEXT_PUBLIC_API_URL=http://158.160.68.33:3001/api
      - NEXT_PUBLIC_WS_URL=ws://158.160.68.33:3001
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      - S3_BUCKET=${S3_BUCKET}
    ports:
      - 80:3000
    networks:
      - mw-net

  metabase:
    image: metabase/metabase:v0.50.29
    restart: unless-stopped
    ports:
      - 3003:3000
    volumes:
      - ./data:/data
    environment:
      - MB_DB_FILE=/data/metabase.db
      - MB_DB_TYPE=h2

  chroma:
    image: chromadb/chroma:0.5.18
    restart: unless-stopped
    ports:
      - 8000:8000
    volumes:
      - chroma-data:/chroma/chroma
    networks:
      - mw-net

networks:
  mw-net:

volumes:
  chroma-data:
